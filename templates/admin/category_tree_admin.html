{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    ul.category-tree { list-style-type: none; padding-left: 20px; }
    li.category-node { margin: 4px 0; cursor: pointer; }
    ul.category-children { display: none; }
    li.category-node.expanded > ul.category-children { display: block; }
    .category-link {
      text-decoration: none;
      color: #0050b3;
      font-weight: 500;
      margin-right: 8px;
    }
    .category-actions button {
      margin-left: 4px;
      padding: 0 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .change-parent-form {
      display: inline-block;
      margin-left: 8px;
    }
    .change-parent-form input {
      width: 160px;
    }
  </style>
{% endblock %}

{% block content %}
  <h1>Category Tree</h1>

  <!-- Expose CSRF token -->
  <form style="display: none;">{% csrf_token %}</form>

  <ul id="categoryTree" class="category-tree"></ul>

  <script>
    function getCSRFToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function moveCategory(id, direction) {
      fetch(`/api/categories/${id}/move-${direction}/?steps=1`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json"
        },
        credentials: "include"
      }).then((res) => {
        if (res.ok) location.reload();
        else alert("Failed to move category.");
      });
    }

    function changeParent(id, newParentName) {
      if (newParentName === "" || newParentName.toLowerCase() === "none") {
        return fetch(`/api/categories/${id}/`, {
          method: "PATCH",
          headers: {
            "X-CSRFToken": getCSRFToken(),
            "Content-Type": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({ parent: null })
        }).then(res => {
          if (res.ok) location.reload();
          else alert("Failed to change parent.");
        });
      }

      const parent = allCategories.find(c => c.name === newParentName);
      if (!parent) {
        alert("Parent not found.");
        return;
      }

      fetch(`/api/categories/${id}/`, {
        method: "PATCH",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify({ parent: parent.id })
      }).then(res => {
        if (res.ok) location.reload();
        else alert("Failed to change parent.");
      });
    }

    let allCategories = [];

    function renderTree(node) {
      const li = $('<li class="category-node"></li>');
      const link = $('<a class="category-link" target="_blank"></a>');

      let label = `<strong>${node.name}</strong>`;
      if (node.similar_to && node.similar_to.length > 0) {
        label += ` <span style="color:#666; font-weight: normal;">(Similar to: ${node.similar_to.join(", ")})</span>`;
      }

      link.html(label);
      link.attr("href", `/admin/catalog/category/${node.id}/change/`);

      if (node.image) {
        const img = $(`<img src="${node.image}" style="width: 20px; height: 20px; margin-right: 6px; vertical-align: middle;" alt="thumb"/>`);
        li.append(img);
      }

      li.append(link);

      const buttons = $(`
        <span class="category-actions">
          <button onclick="event.stopPropagation(); moveCategory(${node.id}, 'up')">⬆️</button>
          <button onclick="event.stopPropagation(); moveCategory(${node.id}, 'down')">⬇️</button>
          <button onclick="event.stopPropagation(); toggleChangeParent(this)">Change Parent</button>
        </span>
      `);
      li.append(buttons);

      const form = $(`
        <span class="change-parent-form" style="display:none;">
          <input type="text" placeholder="New parent (or none)" />
          <button>OK</button>
        </span>
      `);
      form.find("button").on("click", function (e) {
        e.stopPropagation();
        const name = form.find("input").val().trim();
        changeParent(node.id, name);
      });

      li.append(form);

      if (node.children && node.children.length > 0) {
        const childrenUl = $('<ul class="category-children"></ul>');
        node.children.forEach(child => {
          childrenUl.append(renderTree(child));
        });
        li.append(childrenUl);
      }

      li.on("click", function (e) {
        e.stopPropagation();
        $(this).toggleClass("expanded");
      });

      return li;
    }

    function toggleChangeParent(button) {
      const form = $(button).closest("li").find(".change-parent-form");
      form.toggle();
      form.find("input").focus();
    }

    $(function () {
      $.getJSON('/api/categories/tree/', function (data) {
        allCategories = flattenTree(data);
        const root = $('#categoryTree');
        data.forEach(node => {
          root.append(renderTree(node));
        });
      });
    });

    function flattenTree(data) {
      const flat = [];
      function visit(node) {
        flat.push({ id: node.id, name: node.name });
        if (node.children) node.children.forEach(visit);
      }
      data.forEach(visit);
      return flat;
    }
  </script>
{% endblock %}
